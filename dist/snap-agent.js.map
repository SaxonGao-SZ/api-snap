{"version":3,"file":"snap-agent.js","sources":["../snap-agent/buffer.js","../snap-agent/index.js"],"sourcesContent":["\r\nexport default class Buffer {\r\n    static buf = {};\r\n    static length = 0;\r\n\r\n    /**\r\n     * \r\n     * @param {any} aKey - 用于生成 akey 的数据\r\n     * @param {any} bKey - 用于生成 akey 的数据\r\n     * @param {any} valueData - 存储在 key 中的数据\r\n     * @param {(length: number)=>void} callBack\r\n     */\r\n    static set(aKey, bKey = null, valueData = null, callBack) {\r\n        if (!aKey) return this.length;\r\n        let _this = this;\r\n        setTimeout(() => {\r\n            try {\r\n                let a = `${Array.from(aKey).join('~')}`;\r\n                let b = `${!bKey ? Array.from(bKey).join('~') : 'null'}`;\r\n                if (typeof _this.buf[a] === 'undefined') {\r\n                    _this.buf[a] = {};\r\n                    _this.length++;\r\n\r\n                }\r\n                if (bKey){\r\n                    _this.buf[a][b] = valueData ? _this.tarStr(valueData) : '';\r\n                }\r\n                if (callBack)\r\n                    callBack(_this.length);\r\n                console.log('Buffer.set', _this.length);\r\n            } catch (err) {\r\n                console.error('Buffer.set Error', err);\r\n            }\r\n\r\n        }, 0)\r\n    };\r\n    /**\r\n     * 过滤掉不需要的字符\r\n     * @param {string} data \r\n     */\r\n    static tarStr(data) {\r\n        let tmp = data.replace(/\\/\\/(.+)(\\r|\\n)?/g, '/*$1$2*/'); // 去掉单行注释\r\n        tmp = tmp.replace(/\\r/g, ''); //\\r 替换\r\n        tmp = tmp.replace(/[ ]{2,}/g, ' ');  // 去掉两个以上的空格，保留一个\r\n        tmp = tmp.replace(/>[ ]+</g, '><');  // 去掉标签中间的空格    \r\n        tmp = tmp.replace(/[ ]?([=:;]{1,3})[ ]?/g, '$1');  // 去掉等号两边的空格    \r\n        return tmp;\r\n    }\r\n\r\n    /**\r\n     * 转化为 JSON\r\n     * @return {string}\r\n     */\r\n    static toJson(){\r\n        return JSON.stringify(this.buf);\r\n    }\r\n\r\n    static reset() {\r\n        this.buf = {};\r\n        this.length = 0;\r\n    }\r\n}\r\n\r\nwindow.ApiSnapAgentBuffer = Buffer;","import Buffer from './buffer';\r\nclass Agent {\r\n\r\n    static bufAKey = null;\r\n    static bufBKey = null;\r\n    static reportUrl = '';\r\n\r\n    static isOnLoadSetted = false;\r\n\r\n    static bufMaxLen = 2;\r\n\r\n    static setBufAKey(value) {\r\n        console.log('Agent.setBufAKey', value, Date.now());\r\n        this.bufAKey = value;\r\n    }\r\n\r\n    static getBufAKey() {\r\n        console.log('Agent.getBufAKey this.bufAKey', this.bufAKey, Date.now());\r\n        let key = null; // 创建一个 null 指针\r\n        key = this.bufAKey; // 指到 this.bufAKey\r\n        console.log('Agent.getBufKey key', key, Date.now());\r\n        return key;\r\n    }\r\n\r\n    static clearBufAKey() {\r\n        this.bufAKey = null; // this.bufAKey 清空\r\n    }\r\n\r\n    static setBufBKey(value) {\r\n        console.log('Agent.setBufBKey', value, Date.now());\r\n        this.bufBKey = value;\r\n    }\r\n\r\n\r\n    static getBufBKey() {\r\n        console.log('Agent.getBufKey this.bufBKey', this.bufBKey, Date.now());\r\n        let key = null; // 创建一个 null 指针\r\n        key = this.bufBKey; // 指到 this.bufBKey\r\n        this.bufBKey = null; // this.bufBKey 清空\r\n        console.log('Agent.getBufKey key', key, Date.now());\r\n        return key;\r\n    }\r\n\r\n    static clearBufBKey() {\r\n        this.bufBKey = null; // this.bufBKey 清空\r\n    }\r\n\r\n    static initial() {\r\n        console.log('Agent.initial...');\r\n        this.initialOpen();\r\n        this.initialSend();\r\n        this.getReportUrl();\r\n        console.log('Agent.initial done');\r\n    }\r\n\r\n    static getReportUrl() {\r\n        let request = new Request('..//runtime/state.json', {method: \"GET\"});\r\n        let _this = this;\r\n        fetch(request)\r\n            .then(response => {\r\n                return response.json();\r\n            })\r\n            .then( datas => {\r\n                datas.forEach(item=>{\r\n                    if (item.indexOf(window.location.hostname) >= 0){\r\n                        _this.reportUrl = `${item}/set`;\r\n                    }\r\n                    return;\r\n                })\r\n    \r\n            } )\r\n            .catch()\r\n    }\r\n\r\n    /**\r\n     * 初始化 XMLHttpRequest.prototype.open 方法，使其可以截获参数\r\n     */\r\n    static initialOpen() {\r\n        console.log('Agent.initialOpen');\r\n        let _this = this;\r\n        let oOpen = XMLHttpRequest.prototype.open;\r\n        XMLHttpRequest.prototype.open = function () {\r\n            // scope: XMLHttpRequest\r\n            console.log('XMLHttpRequest.open', this, arguments);\r\n            _this.setBufAKey(arguments);\r\n            Buffer.set(arguments, '');\r\n            oOpen.apply(this, [...arguments]);\r\n            _this.initialOnload(this);\r\n        }\r\n    }\r\n\r\n\r\n\r\n    /**\r\n     * 初始化 XMLHttpRequest.prototype.send 方法，使其可以截获参数\r\n     */\r\n    static initialSend() {\r\n        console.log('Agent.initialSend');\r\n        let oSend = XMLHttpRequest.prototype.send;\r\n        let _this = this;\r\n        XMLHttpRequest.prototype.send = function () {\r\n            console.log('XMLHttpRequest.send', this, arguments);\r\n            let aKey = _this.getBufAKey();\r\n            _this.setBufBKey(arguments);\r\n            Buffer.set(aKey, arguments);\r\n            oSend.apply(this, [...arguments]);\r\n        }\r\n    }\r\n\r\n\r\n    static initialOnload(xhr) {\r\n        // onload 方法只存在于实例中，目前只能这么处理\r\n        let oOnload = xhr.onload;\r\n        let _this = this;\r\n        xhr.onload = function () {\r\n            console.log('XMLHttpRequest.onload', arguments);\r\n            let aKey = _this.getBufAKey();\r\n            let bKey = _this.getBufBKey();\r\n            Buffer.set(aKey, bKey, xhr.response, (bufLen) => {\r\n                if (bufLen >= _this.bufMaxLen) {\r\n                    console.log('XMLHttpRequest.onload', `${bufLen}/${_this.bufMaxLen}`);\r\n                    _this.report();\r\n                }\r\n            });\r\n            oOnload && oOnload.apply(xhr, [...arguments])\r\n        };\r\n        xhr.isOnLoadSetted = true;\r\n    }\r\n\r\n    static report() {\r\n        console.log('Agent.report');\r\n        let request = new Request(this.reportUrl,{\r\n            method: 'post', \r\n            body: Buffer.toJson(),\r\n        });\r\n        fetch(request)\r\n        .then().catch();\r\n    }\r\n\r\n}\r\nAgent.initial();\r\nconst apiSnapAgent = function () {\r\n    // Agent.initial();\r\n}\r\n\r\n\r\n\r\nexport default apiSnapAgent;"],"names":[],"mappings":"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"}